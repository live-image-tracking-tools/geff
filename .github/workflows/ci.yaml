name: Test geff

on:
  push:
    branches: [main]
    tags:
      - v*
      - spec-v*
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-typing:
    name: Type checking
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - name: Run type checks
        run: uv run pyright

  test:
    name: ${{ matrix.platform }} ${{ matrix.python-version }} ${{ matrix.group }} ${{ matrix.resolution }}
    runs-on: ${{ matrix.platform }}
    env:
      # disable resyncing on uv run
      UV_NO_SYNC: "1"
      # test package pre-releases on cron-scheduled runs
      UV_PRERELEASE: ${{ github.event_name == 'schedule' && 'allow' || 'if-necessary-or-explicit' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        platform: [ubuntu-latest, macos-latest, windows-latest]
        resolution: [highest, lowest-direct]
        group: [test, test-third-party]
        exclude:
          - group: test
            resolution: lowest-direct # (already tested by third-party group)

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true

      - name: Install dependencies
        run: uv sync --no-dev --group ${{ matrix.group }} --resolution ${{ matrix.resolution }}

      - name: Get witty cache directory
        if: matrix.group == 'test-third-party'
        id: cache-path
        shell: bash
        run: |
          dir=$(uv run python -c 'import witty; print(witty.get_witty_cache_dir())')
          echo "path=$dir" >> "$GITHUB_OUTPUT"

      - name: Restore witty cache
        if: matrix.group == 'test-third-party'
        uses: actions/cache/restore@v4
        id: witty-cache
        with:
          path: ${{ steps.cache-path.outputs.path }}
          key: ${{ matrix.platform }} - ${{ matrix.python-version }}

      - name: Test
        run: |
          uv run coverage run -m pytest --color=yes -v
          uv run coverage xml

      - name: Coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Save witty cache
        if: matrix.group == 'test-third-party'
        uses: actions/cache/save@v4
        with:
          path: ${{ steps.cache-path.outputs.path }}
          key: ${{ matrix.platform }} - ${{ matrix.python-version }}

  # Test geff-spec independently to catch any issues with dependencies
  test-spec:
    runs-on: ubuntu-latest
    env:
      # disable resyncing on uv run
      UV_NO_SYNC: "1"
      # test package pre-releases on cron-scheduled runs
      UV_PRERELEASE: ${{ github.event_name == 'schedule' && 'allow' || 'if-necessary-or-explicit' }}
    
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python 3.13
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          enable-cache: true

      - name: Set up isolated geff-spec environment
      - name: Test geff-spec
        run: uv run --with pytest --package geff-spec --no-dev pytest packages/geff-spec

  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
      - uses: CodSpeedHQ/action@v4
        with:
          run: uv run --group bench --no-dev pytest --codspeed -v packages/geff/tests/test_bench.py
          mode: instrumentation

  build-and-inspect-package:
    name: Build & inspect package.
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: hynek/build-and-inspect-python-package@v2
        with:
          path: packages/geff-spec
          upload-name-suffix: geff-spec
      - name: Clear dist output directory
        run: rm -r /tmp/baipp/dist
      - uses: hynek/build-and-inspect-python-package@v2
        with:
          path: packages/geff
          upload-name-suffix: geff

  upload-geff-to-pypi:
    if: success() && startsWith(github.ref, 'refs/tags/v') && github.event_name != 'schedule'
    name: Upload package to PyPI
    needs: build-and-inspect-package
    runs-on: ubuntu-latest
    permissions:
      id-token: write # this permission is required for trusted publishing
      contents: write # this permission is required for generate_release_notes
    steps:
      - name: Download built artifact to dist/
        uses: actions/download-artifact@v6
        with:
          name: Packagesgeff
          path: dist
          merge-multiple: true
      - name: ðŸš¢ Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
      - name: Generate geff changelog
        uses: mikepenz/release-changelog-builder-action@v6
        id: build_changelog
        with:
          includeOnlyPaths: | # Should work after v6 release
            docs/
            packages/geff
          configuration: changelog-config.json
          configurationJson: | # Filter only geff tags
            {
              "tag_resolver": {
                "method": "semver",
                "filter": {
                  "pattern": "^v"
                }
              }
            }
          toTag: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: softprops/action-gh-release@v2
        with:
          body: ${{steps.build_changelog.outputs.changelog}}
          files: "./dist/*"

  upload-geff-spec-to-pypi:
    if: success() && startsWith(github.ref, 'refs/tags/spec') && github.event_name != 'schedule'
    name: Upload package to PyPI
    needs: build-and-inspect-package
    runs-on: ubuntu-latest
    permissions:
      id-token: write # this permission is required for trusted publishing
      contents: write # this permission is required for generate_release_notes
    steps:
      - name: Download built artifact to dist/
        uses: actions/download-artifact@v6
        with:
          name: Packagesgeff-spec
          path: dist
          merge-multiple: true
      - name: ðŸš¢ Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
      - name: Generate geff-spec changelog
        uses: mikepenz/release-changelog-builder-action@v6
        id: build_changelog_spec
        with:
          includeOnlyPaths: | # Should work after v6 release
            packages/geff-spec
          configuration: changelog-config.json
          configurationJson: | # Filter only geff-spec tags
            {
              "tag_resolver": {
                "method": "semver",
                "filter": {
                  "pattern": "^spec"
                }
              }
            }
          toTag: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: softprops/action-gh-release@v2
        with:
          body: ${{steps.build_changelog_spec.outputs.changelog}}
          files: "./dist/*"